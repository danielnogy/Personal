@page "/identity/users/EditUser/{userId}"
@attribute [Authorize]

<MudText Typo="Typo.h5" Color="Color.Primary">@Resource.Edit_User <MudChip Text="purple" Color="Color.Primary" Label="true">@($"{UserForEdit.UserName?.ToUpper()}")</MudChip></MudText>
<EditForm Model="UserForEdit" OnValidSubmit="SubmitForm">
    <EditContextApiExceptionFallback @ref="EditContextApiExceptionFallback" />
    <FluentValidationValidator />
    <MudHidden @bind-Value="UserForEdit.ConcurrencyStamp" />
    <MudCard>
        <MudCardContent>
            <MudTabs KeepPanelsAlive="true" Elevation="25" Color="Color.Transparent" Rounded="true" PanelClass="mt-6">
                <MudTabPanel Text="@Resource.Avatar" Icon="@Icons.Material.Filled.Photo">
                    <MudCard Elevation="25">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@Resource.Profile_Picture</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudPaper Class="pa-2" Outlined="true">
                                    <AvatarViewer AvatarImageSrc="@AvatarImageSrc" AvatarUri="@UserForEdit.AvatarUri" OnAvatarCleared="() => UserForEdit.AvatarUri=null"></AvatarViewer>
                                    <MudText Align="Align.Center">@($"{UserForEdit.Name} {UserForEdit.Surname}")</MudText>
                                    <MudText Align="Align.Center">@UserForEdit.JobTitle</MudText>
                                </MudPaper>
                            </MudCardContent>
                            <MudCardActions Class="d-flex justify-center">
                                <div class="form-group">
                                    <BpFileUpload @ref="BpFileUploadReference" ButtonId="avatarInput"
                                                  UploadFileButtonIcon="@Icons.Material.Filled.CloudUpload"
                                                  UploadFileButtonName="@Resource.Upload_Avatar"
                                                  ShowRenameFileDialog="false"
                                                  AllowedExtensions=".jpg,.png,.jpg,.bmp"
                                                  AllowedFileSize="5242880"
                                                  OnFileSelected="AvatarSelected"
                                                  OnFileUnSelected="AvatarUnSelected"
                                                  OnImageSrcChanged="GetBase64StringImageUrl" />
                                    <ValidationMessage For="@(() => UserForEdit.AvatarUri)" />
                                </div>
                            </MudCardActions>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="@Resource.Profile" Icon="@Icons.Material.Filled.Person">
                        <MudCard Elevation="25">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">@Resource.User_Profile</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudTextField Label="@Resource.Name"
                                              Variant="Variant.Outlined"
                                              @bind-Value="UserForEdit.Name"
                                              For="@(() => UserForEdit.Name)" />

                                <MudTextField Label="@Resource.Surname"
                                              Variant="Variant.Outlined"
                                              @bind-Value="UserForEdit.Surname"
                                              For="@(() => UserForEdit.Surname)" />

                                <MudTextField Label="@Resource.Job_Title"
                                              Variant="Variant.Outlined"
                                              @bind-Value="UserForEdit.JobTitle"
                                              For="@(() => UserForEdit.JobTitle)" />

                                <MudTextField Label="@Resource.Phone_Number"
                                              Variant="Variant.Outlined"
                                              @bind-Value="UserForEdit.PhoneNumber"
                                              For="@(() => UserForEdit.PhoneNumber)" />
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="@Resource.Account" Icon="@Icons.Material.Filled.Mail">
                        <MudCard Elevation="25">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">@Resource.User_Account</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudTextField Label="@Resource.Email"
                                              Disabled="true"
                                              Variant="Variant.Outlined"
                                              @bind-Value="@CurrentEmail" />

                                <MudTextField Label="@Resource.New_Email"
                                              ValueChanged="@(CanSendActivationEmail)"
                                              Variant="Variant.Outlined"
                                              T="string"
                                              For="@(() => UserForEdit.Email)" />

                                <MudSwitch @bind-Checked="@UserForEdit.MustSendActivationEmail"
                                           Disabled="SendActivationEmailDisabled && CurrentEmail == UserForEdit.Email"
                                           Label="@Resource.Send_Activation_Email"
                                           Color="Color.Info" />

                                <MudSwitch @bind-Checked="@UserForEdit.IsSuperAdmin"
                                           Label="@Resource.SuperAdmin"
                                           T="bool"
                                           Color="Color.Warning" />

                                <MudSwitch @bind-Checked="@UserForEdit.IsSuspended"
                                           Label="@Resource.Suspend"
                                           T="bool"
                                           Color="Color.Error" />
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>

                    @*  <MudTabPanel Text="@Resource.Password" Icon="@Icons.Material.Filled.VpnKey">
                <MudCard Elevation="25">
                <MudCardHeader>
                <CardHeaderContent>
                <MudText Typo="Typo.h6">@Resource.Change_User_Password</MudText>
                </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                <MudSwitch @bind-Checked="@UserForEdit.SetRandomPassword" Label="@Resource.Set_Random_Password" Color="Color.Info" />
                <MudTextField Label="@Resource.Password"
                Variant="Variant.Outlined"
                @bind-Value="UserForEdit.Password"
                For="@(() => UserForEdit.Password)"
                InputType="@PasswordInput"
                Adornment="Adornment.End"
                AdornmentIcon="@PasswordInputIcon"
                Disabled="UserForEdit.SetRandomPassword"
                OnAdornmentClick="TogglePasswordVisibility" />
                <MudTextField Label="@Resource.Confirm_Password"
                Variant="Variant.Outlined"
                @bind-Value="UserForEdit.ConfirmPassword"
                For="@(() => UserForEdit.ConfirmPassword)"
                InputType="@PasswordInput"
                Adornment="Adornment.End"
                AdornmentIcon="@PasswordInputIcon"
                Disabled="UserForEdit.SetRandomPassword"
                OnAdornmentClick="TogglePasswordVisibility" />
                </MudCardContent>
                </MudCard>
                </MudTabPanel>*@

                    <MudTabPanel Text="@Resource.Roles" Icon="@Icons.Material.Filled.GroupWork" Disabled="UserForEdit.IsStatic">
                        <MudCard Elevation="25">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">@Resource.Assign_Roles</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <UserRolesForEdit RoleItems="AssignedUserRoles" OnAssignedRolesChanged="UpdateUserRoles"></UserRolesForEdit>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                    <MudTabPanel Text="@Resource.Documents" Icon="@Icons.Material.Filled.AttachFile">
                        <MudCard Elevation="25">
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">@Resource.User_Documents</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <BpMultipleFileUpload @ref="BpMultipleFileUploadReference" UploadFileButtonIcon="@Icons.Material.Filled.CloudUpload"
                                                      UploadFileButtonName="@Resource.Upload_File"
                                                      ShowRenameFileDialog="true"
                                                      MaxFileSize="524288000"
                                                      OnFileSelected="AttachmentSelected"
                                                      OnFileUnSelected="AttachmentUnSelected" />

                                <ValidationMessage For="@(() => UserForEdit.NumberOfAttachments)" />
                                <UserAttachmentsForEdit AttachmentsList="UserAttachmentList"
                                                        OnAttachmentRemoved="RemoveFromUserCurrentAttachments">
                                </UserAttachmentsForEdit>
                            </MudCardContent>
                        </MudCard>
                    </MudTabPanel>
                </MudTabs>
            </MudCardContent>
    <MudCardActions Class="pb-4 pl-4">
        <MudButton ButtonType="ButtonType.Submit"
                   Variant="Variant.Filled"
                   Color="Color.Primary"
                   Class="ml-auto"
                   FullWidth="true">
            <MudText>@Resource.Save</MudText>
        </MudButton>
    </MudCardActions>
    <MudDivider />
    <MudExpansionPanels>
        <MudExpansionPanel Text="@Resource.Validation_Summary" IsExpanded="true" Disabled="true" HideIcon="true">
            <MudText Color="@Color.Error">
                <ValidationSummary />
            </MudText>
        </MudExpansionPanel>
    </MudExpansionPanels>
</MudCard>
</EditForm>
